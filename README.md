# SQL

-- SQL SERVER – Get Current Database NameSELECT DB_NAME() AS DataBaseName
SELECT name as DBName, @@version as SQL_Server_Version, compatibility_level as Compatibility_Level FROM sys.databases 
-- To check SQL Server VersionSELECT @@VERSION AS 'SQL Server Version';
SELECTSERVERPROPERTY('ProductLevel') AS ProductLevel,SERVERPROPERTY('ProductUpdateLevel') AS ProductUpdateLevel,SERVERPROPERTY('ProductBuildType') AS ProductBuildType,SERVERPROPERTY('ProductUpdateReference') AS ProductUpdateReference,SERVERPROPERTY('ProductVersion') AS ProductVersion,SERVERPROPERTY('ProductMajorVersion') AS ProductMajorVersion,SERVERPROPERTY('ProductMinorVersion') AS ProductMinorVersion,SERVERPROPERTY('ProductBuild') AS ProductBuildGO
SELECT Serverproperty('Edition')
-- Online CPUselect scheduler_id, cpu_id, status, is_online from sys.dm_os_schedulers where status = 'VISIBLE ONLINE'
-- User created date:SELECT name, createdate, updatedate FROM master..syslogins
--Database Name and ID information:SELECT name,dbid FROM master.dbo.sysdatabases ORDER BY dbid
-- To check how much % data is restored in DB:select percent_complete from sys.dm_exec_requests where session_id=83select percent_complete, start_time, estimated_completion_time/60/1000 as Estimate_Complition_Time  from sys.dm_exec_requests where session_id = '78'
--USER ACCESSxp_logininfo 'USER'
EXEC sp_helpdb @dbname= 'MSDB'
-- Instance database infosp_helpDB 
-- Last Update statistics-- https://sqldbpool.com/2011/01/11/script-to-get-the-last-update-statistics-date/
SELECT sysobj.name AS objectname,sysindex.name AS indexname,Stats_date(sysindex.[object_id], sysindex.index_id) AS[Statistics Update Date],CASE sysstats.auto_createdWHEN 0 THEN 'No'WHEN 1 THEN 'Yes'END ASisstatscreatedbyqueryprocessor,CASE sysstats.user_createdWHEN 0 THEN 'No'WHEN 1 THEN 'Yes'END ASisstatscreatedbyuser,CASE sysstats.no_recomputeWHEN 0 THEN 'No'WHEN 1 THEN 'Yes'END ASisstatscreatedwithnorecomputeoptionFROM sys.objects AS sysobj WITH (nolock)INNER JOIN sys.indexes AS sysindex WITH (nolock)ON sysobj.[object_id] = sysindex.[object_id]INNER JOIN sys.stats AS sysstats WITH (nolock)ON sysindex.[object_id] = sysstats.[object_id]AND sysindex.index_id = sysstats.stats_idWHERE sysobj.[type] IN ( 'U', 'V' )ORDER BY Stats_date(sysindex.[object_id], sysindex.index_id) desc;
-- Script to check when was SQL Server restarted
SELECT sqlserver_start_time FROM sys.dm_os_sys_info;   SELECT login_time FROM sys.dm_exec_sessions WHERE session_id = 1;   select start_time from sys.traces where is_default = 1   SELECT crdate FROM sysdatabases WHERE name='tempdb'   SELECT create_date FROM sys.databases WHERE name = 'tempdb' 

-- Update stats for specific table-- https://www.simple-talk.com/sql/performance/managing-sql-server-statistics/
USE [AdventureWorks2012];GO EXEC sp_helpstats 'Sales.SalesOrderDetail', 'ALL';GO SELECT  [sch].[name] + '.' + [so].[name] AS [TableName] ,        [si].[index_id] AS [Index ID] ,        [ss].[name] AS [Statistic] ,        STUFF(( SELECT  ', ' + [c].[name]                FROM    [sys].[stats_columns] [sc]                        JOIN [sys].[columns] [c]                         ON [c].[column_id] = [sc].[column_id]                            AND [c].[object_id] = [sc].[OBJECT_ID]                WHERE   [sc].[object_id] = [ss].[object_id]                        AND [sc].[stats_id] = [ss].[stats_id]                ORDER BY [sc].[stats_column_id]              FOR                XML PATH('')              ), 1, 2, '') AS [ColumnsInStatistic] ,        [ss].[auto_Created] AS [WasAutoCreated] ,        [ss].[user_created] AS [WasUserCreated] ,        [ss].[has_filter] AS [IsFiltered] ,        [ss].[filter_definition] AS [FilterDefinition] ,        [ss].[is_temporary] AS [IsTemporary]FROM    [sys].[stats] [ss]        JOIN [sys].[objects] AS [so] ON [ss].[object_id] = [so].[object_id]        JOIN [sys].[schemas] AS [sch] ON [so].[schema_id] = [sch].[schema_id]        LEFT OUTER JOIN [sys].[indexes] AS [si]              ON [so].[object_id] = [si].[object_id]                 AND [ss].[name] = [si].[name]WHERE   [so].[object_id] = OBJECT_ID(N'Sales.SalesOrderDetail')ORDER BY [ss].[user_created] ,        [ss].[auto_created] ,        [ss].[has_filter];GO
--sp_whoisactive--SELECT DISTINCT s.login_name, s.program_name,r.session_id, r.blocking_session_id, --(wait_time/1000)/60 as minutes_blocked, r.start_time--FROM sys.dm_exec_requests as r--inner join sys.dm_exec_sessions as s--on r.session_id =s.session_id--WHERE r.blocking_session_id <> 0; 
-- Find queries that take the most CPU overallSELECT TOP 50     ObjectName          = OBJECT_SCHEMA_NAME(qt.objectid,dbid) + '.' + OBJECT_NAME(qt.objectid, qt.dbid)     ,TextData           = qt.text     ,DiskReads          = qs.total_physical_reads   -- The worst reads, disk reads     ,MemoryReads        = qs.total_logical_reads    --Logical Reads are memory reads     ,Executions         = qs.execution_count     ,TotalCPUTime       = qs.total_worker_time     ,AverageCPUTime     = qs.total_worker_time/qs.execution_count     ,DiskWaitAndCPUTime = qs.total_elapsed_time     ,MemoryWrites       = qs.max_logical_writes     ,DateCached         = qs.creation_time     ,DatabaseName       = DB_Name(qt.dbid)     ,LastExecutionTime  = qs.last_execution_time  FROM sys.dm_exec_query_stats AS qs  CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS qt  ORDER BY qs.total_worker_time DESC  -- Find queries that have the highest average CPU usageSELECT TOP 50     ObjectName          = OBJECT_SCHEMA_NAME(qt.objectid,dbid) + '.' + OBJECT_NAME(qt.objectid, qt.dbid)     ,TextData           = qt.text        ,DiskReads          = qs.total_physical_reads   -- The worst reads, disk reads     ,MemoryReads        = qs.total_logical_reads    --Logical Reads are memory reads     ,Executions         = qs.execution_count     ,TotalCPUTime       = qs.total_worker_time     ,AverageCPUTime     = qs.total_worker_time/qs.execution_count     ,DiskWaitAndCPUTime = qs.total_elapsed_time     ,MemoryWrites       = qs.max_logical_writes     ,DateCached         = qs.creation_time     ,DatabaseName       = DB_Name(qt.dbid)     ,LastExecutionTime  = qs.last_execution_time  FROM sys.dm_exec_query_stats AS qs  CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS qt  ORDER BY qs.total_worker_time/qs.execution_count DESC
-- Information about table -- SELECT * FROM sys.sysobjects WHERE xtype = 'U'
-- Information about Stored Procedure --SELECT COUNT(*)   FROM sys.sysobjects WHERE xtype = 'P'
SELECT * FROM sys.sysobjects WHERE xtype = 'P'
-- Information about Functions --SELECT * FROM sys.sysobjects WHERE xtype = 'FN'
-- Information about Views --SELECT * FROM sys.sysobjects WHERE xtype = 'V'
-- Shows all active processesselect * from sysprocesses
-- SQL SERVER – Find Currently Running Query – T-SQLSELECT sqltext.TEXT,req.session_id,req.status,req.command,req.cpu_time,req.total_elapsed_timeFROM sys.dm_exec_requests reqCROSS APPLY sys.dm_exec_sql_text(sql_handle) AS sqltext 
SELECT sj.name   , sja.*FROM msdb.dbo.sysjobactivity AS sjaINNER JOIN msdb.dbo.sysjobs AS sj ON sja.job_id = sj.job_idWHERE sja.start_execution_date IS NOT NULL   AND sja.stop_execution_date IS NULL/*While running above query if you find any query which is running for long time it can be killed using following command.
KILL [session_id] 
*/
-- Find total number of jobs with Date & TimeSELECT sj.name,  sja.run_requested_date,  CONVERT(VARCHAR(12), sja.stop_execution_date-sja.start_execution_date, 114) DurationFROM msdb.dbo.sysjobactivity sjaINNER JOIN msdb.dbo.sysjobs sjON sja.job_id = sj.job_idWHERE sja.run_requested_date IS NOT NULLORDER BY sja.run_requested_date desc;
--Check Database is Online or notSELECT DB_NAME() AS DatabaseName, DATABASEPROPERTYEX('NM_DBA_Maint', 'Status') AS DBStatus
select * from sys.databases
select     namefrom sys.databaseswhere name = 'DatabaseName'    and state = 0 --Database is online
SELECT'DB_NAME' = db.name,'FILE_NAME' = mf.name,'FILE_TYPE' = mf.type_desc,'FILE_PATH' = mf.physical_name,'STATUS' = mf.state_descFROMsys.databases dbINNER JOIN sys.master_files mfON db.database_id = mf.database_idWHEREdb.state_desc = 'ONLINE' --db.state = 6 -- OFFLINE
-- SQL SERVER – How to Identify Locked Table in SQL Server?SELECTOBJECT_NAME(p.OBJECT_ID) AS TableName,resource_type, resource_descriptionFROMsys.dm_tran_locks lJOIN sys.partitions p ON l.resource_associated_entity_id = p.hobt_id
--- SQL Server User Connection CountSELECT @@ServerName AS server ,NAME AS dbname ,COUNT(STATUS) AS number_of_connections ,GETDATE() AS timestampFROM sys.databases sdLEFT JOIN sysprocesses sp ON sd.database_id = sp.dbidWHERE database_id NOT BETWEEN 1 AND 4GROUP BY NAME
--SQL AGrestore database [CRM_Integration_TST_06] with recovery
--ViewSELECT * FROM INFORMATION_SCHEMA.VIEWS
--TablesSELECT * FROM INFORMATION_SCHEMA.TABLES/* Enabling and configuring Database Mail in SQL Server using T-SQLhttp://www.snapdba.com/2013/04/enabling-and-configuring-database-mail-in-sql-server-using-t-sql/http://www.codeproject.com/Articles/485124/Configuring-Database-Mail-in-SQL-Serverhttps://msdn.microsoft.com/en-us/library/hh245116(v=sql.110).aspx#CompleteWizard*/
-- GRANT permission--To grant permissions for a user or role to execute any procedure in a database:
USE MyDatabaseGOGRANT EXECUTE TO UserOrRoleName;
--To grant permissions for a user or role to execute any procedure in any database:
USE MyDatabaseGOEXEC sp_msforeachdb 'USE ?; GRANT EXECUTE TO UserOrRoleName'
-- File detailuse PSS1sp_helpfilexp_fixeddrives

-- How to transfer logins and passwords between instances of SQL Server--https://support.microsoft.com/en-us/help/918992/how-to-transfer-logins-and-passwords-between-instances-of-sql-server
exec sp_help_revlogin 
-- Counting Rows in all database tables:-- https://blogs.msdn.microsoft.com/jjameson/2008/05/30/counting-rows-in-all-database-tables-in-sql-server/
SELECT    sysobjects.Name    , sysindexes.RowsFROM    sysobjects    INNER JOIN sysindexes    ON sysobjects.id = sysindexes.idWHERE    type = 'U'    AND sysindexes.IndId < 2ORDER BY--    sysobjects.Name sysindexes.rows desc 
SELECT SCHEMA_NAME(tbl.schema_id) as [Schema]     , tbl.Name     , Coalesce((Select pr.name                  From sys.database_principals pr                  Where pr.principal_id = tbl.principal_id)     , SCHEMA_NAME(tbl.schema_id)) as [Owner]     , tbl.max_column_id_used as [Columns]     , CAST(CASE idx.index_id WHEN 1 THEN 1 ELSE 0 END AS bit) AS [HasClusIdx]     , Coalesce( (Select sum (spart.rows)                   from sys.partitions spart                   Where spart.object_id = tbl.object_id and spart.index_id < 2), 0) AS [Row_Count]     , Coalesce( (Select Cast(v.low/1024.0 as float) * SUM(a.used_pages - CASE WHEN a.type <> 1 THEN a.used_pages WHEN p.index_id < 2 THEN a.data_pages ELSE 0 END)                   FROM sys.indexes as i                  JOIN sys.partitions as p ON p.object_id = i.object_id and p.index_id = i.index_id                  JOIN sys.allocation_units as a ON a.container_id = p.partition_id                  Where i.object_id = tbl.object_id  )      , 0.0) AS [Index_Size_KB]     , Coalesce( (Select Cast(v.low/1024.0 as float) * SUM(CASE WHEN a.type <> 1 THEN a.used_pages WHEN p.index_id < 2 THEN a.data_pages ELSE 0 END)                   FROM sys.indexes as i                  JOIN sys.partitions as p ON p.object_id = i.object_id and p.index_id = i.index_id                  JOIN sys.allocation_units as a ON a.container_id = p.partition_id                  Where i.object_id = tbl.object_id)     , 0.0) AS [Data_Size_KB]     , tbl.create_date, tbl.modify_date
FROM sys.tables AS tbl     INNER JOIN sys.indexes AS idx ON (idx.object_id = tbl.object_id and idx.index_id < 2)     INNER JOIN master.dbo.spt_values v ON (v.number=1 and v.type='E')  ORDER BY Row_Count desc
SELECT   Total_Rows= SUM(st.row_count)FROM   sys.dm_db_partition_stats stWHERE    object_name(object_id) = 'mytable' AND (index_id < 2)
-- First and Last record of any table in databaseSELECT TOP 1 Columnname FROM tablenameORDER BY Columnname ASC;
SELECT TOP 1 Columnname FROM tablenameORDER BY Columnname DESC;
-- Check Mirroring statusSELECT d.name as 'DB', m.mirroring_role_desc as 'Role',  m.mirroring_state_desc as 'State'FROM sys.database_mirroring m JOIN sys.databases dON m.database_id = d.database_idWHERE mirroring_state_desc IS NOT NULL
--Update Statistics:------------------------------------------------------------------------------------------------------------------------------------------------------------------- UpdatStats_FULLSCAN.sql - Does an UpdateStats with FULLSCAN on all tables in current DB.-- SELECT 'update statistics [' + [TABLE_NAME] + '] with FULLSCAN; select ' + ''''+[TABLE_NAME]+'''' + ', getdate();'  FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE != 'VIEW' order by [TABLE_NAME];
-- Database Backup detail:select * from msdb..backupset
select backup_start_date, backup_finish_date, type, backup_size, database_name, recovery_model, compressed_backup_sizefrom msdb..backupset where database_name = 'IADB3S' and type = 'D' order by backup_start_date desc
SELECT rtrim(@@servername) AS SQLServer,backupset.database_name,backupset.backup_start_date,backup_finish_date,CASE backupset.type WHEN 'D' THEN 'Database' WHEN 'L' THEN 'Log' END AS backup_type,backup_size_MB=((backup_size/1024)/1024), msdb.dbo.backupmediafamily.physical_device_name,WeekDay=DATENAME(WEEKDAY, backup_start_date)FROM msdb.dbo.backupmediafamily INNER JOIN msdb.dbo.backupset ON msdb.dbo.backupmediafamily.media_set_id = msdb.dbo.backupset.media_set_id Where msdb.dbo.backupset.database_name like 'DBName%'and (CONVERT(datetime, msdb.dbo.backupset.backup_start_date, 102) >= GETDATE() -30) ORDER BY msdb.dbo.backupset.backup_finish_date desc
Select session_id as spid, command, a.text as query, percent_complete,r.start_time,dateadd(second,estimated_completion_time/1000, getdate()) as Estimated_completionfrom sys.dm_exec_requests r cross apply sys.dm_exec_sql_text(r.sql_handle) awhere r.command in ('BACKUP DATABASE','BACKUP Log','RESTORE Database','RESTORE Log')
-- Schedule SQL Agent JobSELECT DISTINCT substring(a.name,1,100) AS [Job Name],  'Enabled'=case  WHEN a.enabled = 0 THEN 'No' WHEN a.enabled = 1 THEN 'Yes' end,      substring(b.name,1,30) AS [Name of the schedule], 'Frequency of the schedule execution'=case WHEN b.freq_type = 1 THEN 'Once' WHEN b.freq_type = 4 THEN 'Daily' WHEN b.freq_type = 8 THEN 'Weekly' WHEN b.freq_type = 16 THEN 'Monthly' WHEN b.freq_type = 32 THEN 'Monthly relative'  WHEN b.freq_type = 32 THEN 'Execute when SQL Server Agent starts' END,  'Units for the freq_subday_interval'=case WHEN b.freq_subday_type = 1 THEN 'At the specified time'  WHEN b.freq_subday_type = 2 THEN 'Seconds'  WHEN b.freq_subday_type = 4 THEN 'Minutes'  WHEN b.freq_subday_type = 8 THEN 'Hours'  END,  cast(cast(b.active_start_date as varchar(15)) as datetime) as active_start_date,  cast(cast(b.active_end_date as varchar(15)) as datetime) as active_end_date,  Stuff(Stuff(right('000000'+Cast(c.next_run_time as Varchar),6),3,0,':'),6,0,':') as Run_Time,  convert(varchar(24),b.date_created) as Created_Date FROM  msdb.dbo.sysjobs a INNER JOIN msdb.dbo.sysJobschedules c ON a.job_id = c.job_id INNER JOIN msdb.dbo.SysSchedules b on b.Schedule_id=c.Schedule_idGO
-- How to check the progress of the ‘Shrink Database’ task in SQL ServerSELECT percent_complete, start_time, status, command, estimated_completion_time, cpu_time, total_elapsed_timeFROM sys.dm_exec_requests order by percent_complete desc
--Checking the status of SQL Server Agent jobs:http://www.sqlmatters.com/Articles/Checking%20the%20status%20of%20SQL%20Server%20Agent%20jobs.aspx
/*-- Find the Growth Size for All files in All Databases-- OrigionalSELECT   'Database Name' = DB_NAME(database_id) ,'FileName' = NAME,FILE_ID,'size' = CONVERT(NVARCHAR(15), CONVERT(BIGINT, size) * 8) + N' KB','maxsize' = (CASE max_sizeWHEN - 1THEN N'Unlimited'ELSE CONVERT(NVARCHAR(15), CONVERT(BIGINT, max_size) * 8) + N' KB'END) ,'growth' = (CASE is_percent_growthWHEN 1THEN CONVERT(NVARCHAR(15), growth) + N'%'ELSE CONVERT(NVARCHAR(15), CONVERT(BIGINT, growth) * 8) + N' KB'END) ,'type_desc' = type_descFROM sys.master_filesORDER BY database_id
-- ModifiedSELECT   'Database Name' = DB_NAME(database_id) ,'FileName' = NAME,FILE_ID,'size in MB' = CONVERT(NVARCHAR(15), CONVERT(BIGINT, size) * 8/ 1024),'maxsize in MB' = (CASE max_sizeWHEN - 1THEN N'Unlimited'ELSE CONVERT(NVARCHAR(15), CONVERT(BIGINT, max_size) * 8/ 1024)END) ,'growth in MB' = (CASE is_percent_growthWHEN 1THEN CONVERT(NVARCHAR(15), growth) + N'%'ELSE CONVERT(NVARCHAR(15), CONVERT(BIGINT, growth) * 8/ 1024)END) ,'type_desc' = type_descFROM sys.master_filesORDER BY database_id*/

-- Get info about how many connections are active in database:SELECT     DB_NAME(dbid) as DBName, DBID as DatabaseID,    COUNT(dbid) as NumberOfConnections,    loginame as LoginNameFROM    sys.sysprocessesWHERE     dbid > 0GROUP BY     dbid, loginameorder by dbid
-- To check which query is running:-- sp_whoisactiveSELECT sqltext.TEXT,req.session_id,req.status,req.percent_complete,req.command,req.cpu_time,req.total_elapsed_timeFROM sys.dm_exec_requests reqCROSS APPLY sys.dm_exec_sql_text(sql_handle) AS sqltext
--Table Name for DatabaseSELECT '['+SCHEMA_NAME(schema_id)+'].['+name+']'AS SchemaTableFROM sys.tables
-- Get Username & Schemaname select u.name, s.name      from sys.sysusers uinner join sys.schemas s        on s.principal_id = u.uid
--Active SQL Server connectionsSELECT DB_NAME(dbid) AS DBName,COUNT(dbid) AS NumberOfConnections,loginame as LoginNameFROM    sys.sysprocessesGROUP BY dbid, loginameORDER BY DB_NAME(dbid)
-- Create User and add role for AD groupEXEC master..sp_MSforeachdb'USE [?]IF DB_ID() >= 5
BEGIN CREATE USER [NM\AA-COLLABP-SHAREPOINT] FROM LOGIN [NM\AA-COLLABP-SHAREPOINT]
 EXEC sp_addrolemember "db_owner", "NM\AA-COLLABP-SHAREPOINT" EXEC sp_addrolemember "db_securityadmin", "NM\AA-COLLABP-SHAREPOINT"
END'
Script 1 :- For Windows Login
 create login Servername\LoginName from windows
 DECLARE @command varchar(1000) SELECT @command = 'IF ''?'' NOT IN(''master'', ''msdb'', ''tempdb'',''model'') BEGIN USE ? EXEC(''create user Servername\LoginName for login Servername\LoginName'') END '
 EXEC sp_MSforeachdb @command
 DECLARE @command1 varchar(1000)
 Select @command1 = 'IF ''?'' NOT IN(''master'', ''msdb'', ''tempdb'',''model'') BEGIN USE ? EXEC sp_addrolemember ''db_owner'', ''Servername\LoginName'' END'
 EXEC sp_MSforeachdb @command1
-- To get Username & Schemaname USE [master]GO
select u.name as username, s.name as schemaname      from sys.sysusers uinner join sys.schemas s        on s.principal_id = u.uid
-- Database Backup infoSELECT rtrim(@@servername) AS SQLServer,backupset.database_name,backupset.backup_start_date,backup_finish_date,CASE backupset.type WHEN 'D' THEN 'Database' WHEN 'L' THEN 'Log' END AS backup_type,backup_size_MB=((backup_size/1024)/1024), msdb.dbo.backupmediafamily.physical_device_name,WeekDay=DATENAME(WEEKDAY, backup_start_date)FROM msdb.dbo.backupmediafamily INNER JOIN msdb.dbo.backupset ON msdb.dbo.backupmediafamily.media_set_id = msdb.dbo.backupset.media_set_id Where msdb.dbo.backupset.database_name like 'CRM1P_%'and (CONVERT(datetime, msdb.dbo.backupset.backup_start_date, 102) >= GETDATE() -2) ORDER BY msdb.dbo.backupset.backup_finish_date desc
/*--Troubleshooting Insufficient Disk Space in tempdbhttps://technet.microsoft.com/en-us/library/ms176029(v=sql.105).aspx
--TempDB information:USE tempdbGO
sp_helpfile
DBCC SQLPERF(LOGSPACE)
DBCC opentran(tempdb)
DBCC FREEPROCCACHEGO
DBCC DROPCLEANBUFFERSGO
DBCC FREESYSTEMCACHE ('ALL')GO
DBCC FREESESSIONCACHEGO
DBCC shrinkfile (tempdev, 3311) -- tempdev is filename of TempDB --------------------------TempDB usage per active sessionhttp://www.sqlservercentral.com/scripts/tempdb/72007/
;WITH task_space_usage AS (    -- SUM alloc/delloc pages    SELECT session_id,           request_id,           SUM(internal_objects_alloc_page_count) AS alloc_pages,           SUM(internal_objects_dealloc_page_count) AS dealloc_pages    FROM sys.dm_db_task_space_usage WITH (NOLOCK)    WHERE session_id <> @@SPID    GROUP BY session_id, request_id)SELECT TSU.session_id,       TSU.alloc_pages * 1.0 / 128 AS [internal object MB space],       TSU.dealloc_pages * 1.0 / 128 AS [internal object dealloc MB space],       EST.text,       -- Extract statement from sql text       ISNULL(           NULLIF(               SUBSTRING(                   EST.text,                    ERQ.statement_start_offset / 2,                    CASE WHEN ERQ.statement_end_offset < ERQ.statement_start_offset THEN 0 ELSE( ERQ.statement_end_offset - ERQ.statement_start_offset ) / 2 END               ), ''           ), EST.text       ) AS [statement text],       EQP.query_planFROM task_space_usage AS TSUINNER JOIN sys.dm_exec_requests ERQ WITH (NOLOCK)    ON  TSU.session_id = ERQ.session_id    AND TSU.request_id = ERQ.request_idOUTER APPLY sys.dm_exec_sql_text(ERQ.sql_handle) AS ESTOUTER APPLY sys.dm_exec_query_plan(ERQ.plan_handle) AS EQPWHERE EST.text IS NOT NULL OR EQP.query_plan IS NOT NULLORDER BY 3 DESC, 5 DESC*/
---
/*SELECT sdb.Name AS DatabaseName,COALESCE(CONVERT(VARCHAR(12), MAX(bus.backup_finish_date), 101),'-') AS LastBackUpTimeFROM sys.sysdatabases sdbLEFT OUTER JOIN msdb.dbo.backupset bus ON bus.database_name = sdb.nameGROUP BY sdb.Name*/
--------------------------------------------------------------------------------- --Database Backups for all databases For Previous Week --------------------------------------------------------------------------------- SELECT CONVERT(CHAR(100), SERVERPROPERTY('Servername')) AS Server, msdb.dbo.backupset.database_name, msdb.dbo.backupset.backup_start_date, msdb.dbo.backupset.backup_finish_date, msdb.dbo.backupset.expiration_date, CASE msdb..backupset.type WHEN 'D' THEN 'Database' WHEN 'L' THEN 'Log' END AS backup_type, msdb.dbo.backupset.backup_size, msdb.dbo.backupmediafamily.logical_device_name, msdb.dbo.backupmediafamily.physical_device_name, msdb.dbo.backupset.name AS backupset_name, msdb.dbo.backupset.description FROM msdb.dbo.backupmediafamily INNER JOIN msdb.dbo.backupset ON msdb.dbo.backupmediafamily.media_set_id = msdb.dbo.backupset.media_set_id WHERE (CONVERT(datetime, msdb.dbo.backupset.backup_start_date, 102) >= GETDATE() - 7) ORDER BY msdb.dbo.backupset.database_name, msdb.dbo.backupset.backup_finish_date ---/*
-- SQL Server – Check Index Fragmentation on ALL Indexes in a Database
SELECT dbschemas.[name] as 'Schema', dbtables.[name] as 'Table', dbindexes.[name] as 'Index',indexstats.avg_fragmentation_in_percent,indexstats.page_countFROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS indexstatsINNER JOIN sys.tables dbtables on dbtables.[object_id] = indexstats.[object_id]INNER JOIN sys.schemas dbschemas on dbtables.[schema_id] = dbschemas.[schema_id]INNER JOIN sys.indexes AS dbindexes ON dbindexes.[object_id] = indexstats.[object_id]AND indexstats.index_id = dbindexes.index_idWHERE indexstats.database_id = DB_ID()ORDER BY indexstats.avg_fragmentation_in_percent desc----
SELECT OBJECT_NAME(OBJECT_ID) as TableName, index_id as Index_Id,index_type_desc as Index_Desc,index_level,avg_fragmentation_in_percent as Avg_Fragmentation_In_Percent,avg_page_space_used_in_percent as Avg_Page_Space_Used_In_Percent,page_count as PageCountFROM sys.dm_db_index_physical_stats(DB_ID(N'DatabaseName'), NULL, NULL, NULL , 'SAMPLED')ORDER BY avg_fragmentation_in_percent DESC---
SELECT OBJECT_NAME(ind.OBJECT_ID) AS TableName, ind.name AS IndexName, indexstats.index_type_desc AS IndexType, indexstats.avg_fragmentation_in_percent FROM sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL, NULL, NULL) indexstats INNER JOIN sys.indexes ind  ON ind.object_id = indexstats.object_id AND ind.index_id = indexstats.index_id WHERE indexstats.avg_fragmentation_in_percent > 30 ORDER BY indexstats.avg_fragmentation_in_percent DESC

*/--USE CRM4S01_MSCRM-- ORPHANED USERSDECLARE @SQL nvarchar(2000)DECLARE @name nvarchar(128)DECLARE @database_id int
SET NOCOUNT ON;
IF NOT EXISTS     (SELECT name FROM tempdb.sys.tables WHERE name like '%#orphan_users%')BEGIN    CREATE TABLE #orphan_users        (        database_name nvarchar(128) NOT NULL,        [user_name] nvarchar(128) NOT NULL,        drop_command_text nvarchar(200) NOT NULL        )END
CREATE TABLE #databases (    database_id int NOT NULL    , database_name nvarchar(128) NOT NULL    , processed bit NOT NULL)
INSERT    #databases     ( database_id    , database_name    , processed )SELECT     database_id    , name    , 0 FROM     master.sys.databases WHERE     name NOT IN     ('master'    , 'tempdb'    , 'msdb'    , 'distribution'    , 'model')
WHILE (SELECT COUNT(processed) FROM #databases WHERE processed = 0) > 0BEGIN    SELECT TOP 1        @name = database_name,        @database_id = database_id    FROM #databases    WHERE processed = 0    ORDER BY database_id
    SELECT @SQL =
'USE [' + @name + '];INSERT INTO #orphan_users (database_name, user_name, drop_command_text)SELECT     DB_NAME()    , u.name    , ' + ''''     + 'USE [' + @name + ']; '     + 'DROP USER ['     + '''' + ' + u.name     + ' + '''' + '] '     + '''' + 'FROM    master..syslogins lRIGHT JOIN     sysusers u ON l.sid = u.sidWHERE       l.sid IS NULLAND issqlrole <> 1AND isapprole <> 1AND ( u.name <> ' + '''' + 'INFORMATION_SCHEMA' + ''''        + ' AND u.name <> ' + '''' + 'guest' + ''''        + ' AND u.name <> ' + '''' + 'dbo' + ''''        + ' AND u.name <> ' + '''' + 'sys' + ''''        + ' AND u.name <> ' + '''' + 'system_function_schema' + '''' + ')'
    PRINT @SQL;
    EXEC sys.sp_executesql @SQL
    UPDATE         #databases     SET         processed = 1     WHERE         database_id = @database_id;END
SELECT     database_name    , [user_name]    , drop_command_text FROM     #orphan_users ORDER BY     [database_name]    , [user_name];
DROP TABLE #databases;DROP TABLE #orphan_users;
SET NOCOUNT OFF;
-- Custom indexes on CRM Database
SELECT DB_NAME() AS Database_Name , sc.name AS Schema_Name , o.name AS Table_Name , i.name AS Custom_Index_Name , i.type_desc AS Index_Type FROM sys.indexes i INNER JOIN sys.objects o ON i.object_id = o.object_id INNER JOIN sys.schemas sc ON o.schema_id = sc.schema_id WHERE i.name IS NOT NULL AND o.type = 'U'  AND i.name like 'ndxNM_%' AND i.name not like 'ndxNM1_%' ORDER BY o.name, i.type
-- No of Rows & SizeinKBCREATE TABLE #RowCountsAndSizes (TableName NVARCHAR(128),rows CHAR(11),             reserved VARCHAR(18),data VARCHAR(18),index_size VARCHAR(18),        unused VARCHAR(18))
EXEC       sp_MSForEachTable 'INSERT INTO #RowCountsAndSizes EXEC sp_spaceused ''?'' '
SELECT TOP 50    TableName,CONVERT(bigint,rows) AS NumberOfRows,            CONVERT(bigint,left(reserved,len(reserved)-3)) AS SizeinKBFROM       #RowCountsAndSizes ORDER BY   NumberOfRows DESC,SizeinKB DESC,TableName
DROP TABLE #RowCountsAndSizes 
--Find out regarding XEvent data
--dbid--sp_helpdb
--objectid--select * from sys.objects where name like 'p_SystemUserBuEntityMapReinit' 
-- SQL to list indexesUse CRM1P_MSCRMGoselect o.name as TableName,i.name as IndexName,( SELECT c.name + ', '  FROM sys.index_columns ic  JOIN sys.columns c ON ic.column_id = c.column_id and ic.object_id = c.object_id WHERE i.object_id = ic.object_id and i.index_id = ic.index_id   AND ic.is_included_column = 0 ORDER BY ic.index_column_id FOR XML PATH('')) AS Key_Columns,( SELECT c.name + ', '  FROM sys.index_columns ic  JOIN sys.columns c ON ic.column_id = c.column_id and ic.object_id = c.object_id WHERE i.object_id = ic.object_id and i.index_id = ic.index_id   AND ic.is_included_column = 1 ORDER BY ic.index_column_id FOR XML PATH('')) AS IncludedColumns,i.type_desc as IndexType,i.is_unique as IsUnique,i.is_primary_key as IsPrimaryKeyfrom sys.indexes ijoin sys.objects o on i.object_id = o.object_idwhere o.is_ms_shipped = 0-- and o.name in ('ActivityPointerBase','ActivityPartyBase','nm_noteBase','nm_postcallBase','nm_postappointmentBase','PhoneCallBase','AppointmentBase')-- and i.name like 'ndxNM%'and o.name not like 'SyncEntry%'and o.name not like 'SubscriptionStatistics%'order by TableName,IndexName

-- To view the size and file growth parameters of the tempdb data or log files SELECT     name AS FileName,     size*1.0/128 AS FileSizeinMB,    CASE max_size         WHEN 0 THEN 'Autogrowth is off.'        WHEN -1 THEN 'Autogrowth is on.'        ELSE 'Log file will grow to a maximum size of 2 TB.'    END,    growth AS 'GrowthValue',    'GrowthIncrement' =         CASE            WHEN growth = 0 THEN 'Size is fixed and will not grow.'            WHEN growth > 0 AND is_percent_growth = 0                 THEN 'Growth value is in 8-KB pages.'            ELSE 'Growth value is a percentage.'        ENDFROM tempdb.sys.database_files;GO
/*
--Find out who was login in CRM during time frameSELECT TOP 1000 *  FROM [NM_DBA_Maint].[dbo].[CRM_session_info]  where login_time > '2016-02-18 05:00:00.000' and login_time < '2016-02-18 06:00:00.000'  order by 2
SELECT TOP 1000 *  FROM [NM_DBA_Maint].[dbo].[CRM_execrequest_info]  where login_time > '2016-02-18 05:00:00.000' and login_time < '2016-02-18 06:00:00.000'  order by 2
--SpaceUsed:
sp_spaceused Returns information about the total size of the database
sp_spaceused 'MyTable' Returns information about the size of MyTable
Read the docs for all the things you can get information about. You can also use the sp_msforeachtable command to run sp_spaceused against all tables at once.Edit: Be aware the command sometimes returns multiple datasets, each set containing a different chunk of stats*/
/*- Disk Usage by Table
BEGIN try  DECLARE @table_name VARCHAR(500) ;  DECLARE @schema_name VARCHAR(500) ;  DECLARE @tab1 TABLE(         tablename VARCHAR (500) collate database_default ,       schemaname VARCHAR(500) collate database_default );  DECLARE  @temp_table TABLE (             tablename sysname ,       row_count INT ,       reserved VARCHAR(50) collate database_default ,       data VARCHAR(50) collate database_default ,       index_size VARCHAR(50) collate database_default ,       unused VARCHAR(50) collate database_default  );  
INSERT INTO @tab1  SELECT t1.name ,       t2.name  FROM sys.tables t1  INNER JOIN sys.schemas t2 ON ( t1.schema_id = t2.schema_id );    
DECLARE c1 CURSOR FOR  SELECT t2.name + '.' + t1.name   FROM sys.tables t1  INNER JOIN sys.schemas t2 ON ( t1.schema_id = t2.schema_id );    
OPEN c1;  FETCH NEXT FROM c1 INTO @table_name; WHILE @@FETCH_STATUS = 0  BEGIN           SET @table_name = REPLACE(@table_name, '[','');          SET @table_name = REPLACE(@table_name, ']','');  
        -- make sure the object exists before calling sp_spacedused         IF EXISTS(SELECT OBJECT_ID FROM sys.objects WHERE OBJECT_ID = OBJECT_ID(@table_name))         BEGIN                 INSERT INTO @temp_table EXEC sp_spaceused @table_name, false ;         END                  FETCH NEXT FROM c1 INTO @table_name;  END;  CLOSE c1;  DEALLOCATE c1;  SELECT t1.* ,       t2.schemaname  FROM @temp_table t1  INNER JOIN @tab1 t2 ON (t1.tablename = t2.tablename ) ORDER BY  schemaname,tablename; END try  BEGIN catch  SELECT -100 AS l1 ,       ERROR_NUMBER() AS tablename ,       ERROR_SEVERITY() AS row_count ,       ERROR_STATE() AS reserved ,       ERROR_MESSAGE() AS data ,       1 AS index_size, 1 AS unused, 1 AS schemaname  END catch
*/
-- Check total number or tables in DBUSE YOURDBNAMESELECT COUNT(*) from information_schema.tables WHERE table_type = 'base table' 
-- To check when DB backup taken, just change DBName & Dateselect database_name, backup_start_date, backup_finish_date,type,s.user_name, physical_device_nameFROM msdb.dbo.backupset sinner join msdb.dbo.backupmediafamily mON s.media_set_id = m.media_set_idWHERE s.database_name = 'DBNAME' and backup_start_date>'08/26/2013 20:00:00'ORDER BY backup_start_date desc 
-- To Check Errorlog file location on serverUSE MASTERGOEXEC xp_readerrorlog 0, 1, N'Logging SQL Server messages in file'GO
--Database Creation Script:USE [master]GO
/****** Object:  Database <DATABASE_NAME>    Script Date: 4/3/2017 9:57:54 PM ******/CREATE DATABASE <DATABASE_NAME> CONTAINMENT = NONE ON  PRIMARY ( NAME = N'<MDF FILE NAME>', FILENAME = N'<PATH.mdf>' , SIZE = 1048576KB , MAXSIZE = UNLIMITED, FILEGROWTH = 1048576KB ) LOG ON ( NAME = N'<LDF FILE NAME with _log>', FILENAME = N'<PATH_log.ldf>' , SIZE = 512000KB , MAXSIZE = 2048GB , FILEGROWTH = 10%)GO
ALTER DATABASE <DATABASE_NAME> SET COMPATIBILITY_LEVEL = 110GO
IF (1 = FULLTEXTSERVICEPROPERTY('IsFullTextInstalled'))beginEXEC <DATABASE_NAME>.[dbo].[sp_fulltext_database] @action = 'enable'endGO
ALTER DATABASE <DATABASE_NAME> SET ANSI_NULL_DEFAULT OFF GO
ALTER DATABASE <DATABASE_NAME> SET ANSI_NULLS OFF GO
ALTER DATABASE <DATABASE_NAME> SET ANSI_PADDING OFF GO
ALTER DATABASE <DATABASE_NAME> SET ANSI_WARNINGS OFF GO
ALTER DATABASE <DATABASE_NAME> SET ARITHABORT OFF GO
ALTER DATABASE <DATABASE_NAME> SET AUTO_CLOSE OFF GO
ALTER DATABASE <DATABASE_NAME> SET AUTO_CREATE_STATISTICS ON GO
ALTER DATABASE <DATABASE_NAME> SET AUTO_SHRINK OFF GO
ALTER DATABASE <DATABASE_NAME> SET AUTO_UPDATE_STATISTICS ON GO
ALTER DATABASE <DATABASE_NAME> SET CURSOR_CLOSE_ON_COMMIT OFF GO
ALTER DATABASE <DATABASE_NAME> SET CURSOR_DEFAULT  GLOBAL GO
ALTER DATABASE <DATABASE_NAME> SET CONCAT_NULL_YIELDS_NULL OFF GO
ALTER DATABASE <DATABASE_NAME> SET NUMERIC_ROUNDABORT OFF GO
ALTER DATABASE <DATABASE_NAME> SET QUOTED_IDENTIFIER OFF GO
ALTER DATABASE <DATABASE_NAME> SET RECURSIVE_TRIGGERS OFF GO
ALTER DATABASE <DATABASE_NAME> SET  DISABLE_BROKER GO
ALTER DATABASE <DATABASE_NAME> SET AUTO_UPDATE_STATISTICS_ASYNC OFF GO
ALTER DATABASE <DATABASE_NAME> SET DATE_CORRELATION_OPTIMIZATION OFF GO
ALTER DATABASE <DATABASE_NAME> SET TRUSTWORTHY OFF GO
ALTER DATABASE <DATABASE_NAME> SET ALLOW_SNAPSHOT_ISOLATION OFF GO
ALTER DATABASE <DATABASE_NAME> SET PARAMETERIZATION SIMPLE GO
ALTER DATABASE <DATABASE_NAME> SET READ_COMMITTED_SNAPSHOT OFF GO
ALTER DATABASE <DATABASE_NAME> SET HONOR_BROKER_PRIORITY OFF GO
ALTER DATABASE <DATABASE_NAME> SET RECOVERY SIMPLE GO
ALTER DATABASE <DATABASE_NAME> SET  MULTI_USER GO
ALTER DATABASE <DATABASE_NAME> SET PAGE_VERIFY CHECKSUM  GO
ALTER DATABASE <DATABASE_NAME> SET DB_CHAINING OFF GO
ALTER DATABASE <DATABASE_NAME> SET FILESTREAM( NON_TRANSACTED_ACCESS = OFF ) GO
ALTER DATABASE <DATABASE_NAME> SET TARGET_RECOVERY_TIME = 0 SECONDS GO
ALTER DATABASE <DATABASE_NAME> SET  READ_WRITE GO
-- Determining database size using T-SQL scriptingSELECT DB_NAME(database_id) AS DatabaseName, Name AS Logical_Name, Physical_Name, (size*8)/1024 SizeMBFROM sys.master_files
-- DataBase with size in MB and GBSELECT d.NAME    ,ROUND(SUM(mf.size) * 8 / 1024, 0) Size_MBs    ,(SUM(mf.size) * 8 / 1024) / 1024 AS Size_GBsFROM sys.master_files mfINNER JOIN sys.databases d ON d.database_id = mf.database_idWHERE d.database_id > 4 -- Skip system databasesGROUP BY d.NAMEORDER BY d.NAME
SELECT       database_name = DB_NAME(database_id)    , log_size_mb = CAST(SUM(CASE WHEN type_desc = 'LOG' THEN size END) * 8. / 1024 AS DECIMAL(8,2))    , row_size_mb = CAST(SUM(CASE WHEN type_desc = 'ROWS' THEN size END) * 8. / 1024 AS DECIMAL(8,2))    , total_size_mb = CAST(SUM(size) * 8. / 1024 AS DECIMAL(8,2))FROM sys.master_files WITH(NOWAIT)WHERE database_id = DB_ID() -- for current db GROUP BY database_id
SELECT       database_name = DB_NAME(database_id)    , log_size_mb = CAST(SUM(CASE WHEN type_desc = 'LOG' THEN size END) * 8. / 1024 AS DECIMAL(8,2))    , row_size_mb = CAST(SUM(CASE WHEN type_desc = 'ROWS' THEN size END) * 8. / 1024 AS DECIMAL(8,2))    , total_size_mb = CAST(SUM(size) * 8. / 1024 AS DECIMAL(8,2))FROM sys.master_files WITH(NOWAIT)WHERE database_id = DB_ID() -- for current db GROUP BY database_id
-- Show information about size, free space, last database backups
IF OBJECT_ID('tempdb.dbo.#space') IS NOT NULL    DROP TABLE #space
CREATE TABLE #space (      database_id INT PRIMARY KEY    , data_used_size DECIMAL(18,2)    , log_used_size DECIMAL(18,2))
DECLARE @SQL NVARCHAR(MAX)
SELECT @SQL = STUFF((    SELECT '    USE [' + d.name + ']    INSERT INTO #space (database_id, data_used_size, log_used_size)    SELECT          DB_ID()        , SUM(CASE WHEN [type] = 0 THEN space_used END)        , SUM(CASE WHEN [type] = 1 THEN space_used END)    FROM (        SELECT s.[type], space_used = SUM(FILEPROPERTY(s.name, ''SpaceUsed'') * 8. / 1024)        FROM sys.database_files s        GROUP BY s.[type]    ) t;'    FROM sys.databases d    WHERE d.[state] = 0    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '')
EXEC sys.sp_executesql @SQL
SELECT      d.database_id    , d.name    , d.state_desc    , d.recovery_model_desc    , t.total_size    , t.data_size    , s.data_used_size    , t.log_size    , s.log_used_size    , bu.full_last_date    , bu.full_size    , bu.log_last_date    , bu.log_sizeFROM (    SELECT          database_id        , log_size = CAST(SUM(CASE WHEN [type] = 1 THEN size END) * 8. / 1024 AS DECIMAL(18,2))        , data_size = CAST(SUM(CASE WHEN [type] = 0 THEN size END) * 8. / 1024 AS DECIMAL(18,2))        , total_size = CAST(SUM(size) * 8. / 1024 AS DECIMAL(18,2))    FROM sys.master_files    GROUP BY database_id) tJOIN sys.databases d ON d.database_id = t.database_idLEFT JOIN #space s ON d.database_id = s.database_idLEFT JOIN (    SELECT          database_name        , full_last_date = MAX(CASE WHEN [type] = 'D' THEN backup_finish_date END)        , full_size = MAX(CASE WHEN [type] = 'D' THEN backup_size END)        , log_last_date = MAX(CASE WHEN [type] = 'L' THEN backup_finish_date END)        , log_size = MAX(CASE WHEN [type] = 'L' THEN backup_size END)    FROM (        SELECT              s.database_name            , s.[type]            , s.backup_finish_date            , backup_size =                        CAST(CASE WHEN s.backup_size = s.compressed_backup_size                                    THEN s.backup_size                                    ELSE s.compressed_backup_size                        END / 1048576.0 AS DECIMAL(18,2))            , RowNum = ROW_NUMBER() OVER (PARTITION BY s.database_name, s.[type] ORDER BY s.backup_finish_date DESC)        FROM msdb.dbo.backupset s        WHERE s.[type] IN ('D', 'L')    ) f    WHERE f.RowNum = 1    GROUP BY f.database_name) bu ON d.name = bu.database_nameORDER BY t.total_size DESC

--TempDB create dateselect create_date from sys.databases where name like 'tempdb'
-- Drop User from SQL Server DatabaseIF  EXISTS (SELECT * FROM sys.database_principals WHERE name = N'username')DROP USER [username]
/*Uses sys.indexes and sys.dm_db_partition_stats DMF to calculate the size of individual index on a table*/
-- Ensure a USE <databasename> statement has been executed first.SELECT i.[name] AS IndexName    ,SUM(s.[used_page_count]) * 8 AS IndexSizeKBFROM sys.dm_db_partition_stats AS sINNER JOIN sys.indexes AS i ON s.[object_id] = i.[object_id]    AND s.[index_id] = i.[index_id]GROUP BY i.[name]ORDER BY i.[name]GO
-- To check how many users are connected to respective DatabaseSELECT @@ServerName AS server ,NAME AS dbname ,COUNT(STATUS) AS number_of_connections ,GETDATE() AS timestampFROM sys.databases sdLEFT JOIN sysprocesses sp ON sd.database_id = sp.dbidWHERE database_id NOT BETWEEN 1 AND 4GROUP BY NAME
/*Uses sys.dm_db_index_physical_stats and sys.dm_db_partition_stats to calculate the size of individual index on a table. This query is more reliable as compared to first query because it uses DMFs.
Sample output of the second query when executed against AdventureWorks database:*/
--To check CPU Count & RAM in box:SELECT cpu_count AS [Logical CPU Count], hyperthread_ratio AS [Hyperthread Ratio],cpu_count/hyperthread_ratio AS [Physical CPU Count],physical_memory_kb/1048576 AS [Physical Memory (MB)]FROM sys.dm_os_sys_info;--select * FROM sys.dm_os_sys_info;
-- Ensure a USE statement has been executed first.SELECT [DatabaseName]    ,[ObjectId]    ,[ObjectName]    ,[IndexId]    ,[IndexDescription]    ,CONVERT(DECIMAL(16, 1), (SUM([avg_record_size_in_bytes] * [record_count]) / (1024.0 * 1024))) AS [IndexSize(MB)]    ,[lastupdated] AS [StatisticLastUpdated]    ,[AvgFragmentationInPercent]FROM (    SELECT DISTINCT DB_Name(Database_id) AS 'DatabaseName'        ,OBJECT_ID AS ObjectId        ,Object_Name(Object_id) AS ObjectName        ,Index_ID AS IndexId        ,Index_Type_Desc AS IndexDescription        ,avg_record_size_in_bytes        ,record_count        ,STATS_DATE(object_id, index_id) AS 'lastupdated'        ,CONVERT([varchar](512), round(Avg_Fragmentation_In_Percent, 3)) AS 'AvgFragmentationInPercent'    FROM sys.dm_db_index_physical_stats(db_id(), NULL, NULL, NULL, 'detailed')    WHERE OBJECT_ID IS NOT NULL        AND Avg_Fragmentation_In_Percent <> 0    ) TGROUP BY DatabaseName    ,ObjectId    ,ObjectName    ,IndexId    ,IndexDescription    ,lastupdated    ,AvgFragmentationInPercent
-- List of Database history detail:
USE [Database Name]GO
-- Get Backup History for required databaseSELECT TOP 100s.server_name,s.database_name,--m.physical_device_name,s.backup_start_date,s.backup_finish_date,CAST(DATEDIFF(second, s.backup_start_date,s.backup_finish_date) AS VARCHAR(4)) + ' ' + 'Seconds' TimeTaken,CAST(DATEDIFF(MINUTE, s.backup_start_date,s.backup_finish_date) AS VARCHAR(4)) + ' ' + 'Minutes' TimeTaken,s.backup_size as SizeInKB,CAST(CAST(s.backup_size / 1000000 AS INT) AS VARCHAR(14)) + ' ' + 'MB' AS bkSize,CAST(CAST(s.backup_size / 1000000000 AS INT) AS VARCHAR(14)) + ' ' + 'GB' AS bkSize, -- 1073741824--CAST(s.first_lsn AS VARCHAR(50)) AS first_lsn,--CAST(s.last_lsn AS VARCHAR(50)) AS last_lsn,CASE s.[type] WHEN 'D' THEN 'Full'WHEN 'I' THEN 'Differential'WHEN 'L' THEN 'Transaction Log'END AS BackupType-- s.recovery_modelFROM msdb.dbo.backupset sINNER JOIN msdb.dbo.backupmediafamily m ON s.media_set_id = m.media_set_idWHERE s.database_name = DB_NAME() -- Remove this line for all the database ORDER BY backup_start_date DESC, backup_finish_dateGO
/* How to List all Locked SQL Logins in SQL Server
SELECT is_disabled from sys.server_principals WHERE name = @loginname
-- To list all locked SQL logins in SQL Server, use the following query:
SELECT name, is_disabled, LOGINPROPERTY(name, N'isLocked') as is_lockedFROM sys.sql_loginsWHERE LOGINPROPERTY(name, N'isLocked') = 1ORDER BY name;
-- To list all locked SQL logins in SQL Server, including the time when the login was locked out, use the following query:
SELECT name, is_disabled, LOGINPROPERTY(name, N'isLocked') as is_locked,LOGINPROPERTY(name, N'LockoutTime') as LockoutTimeFROM sys.sql_loginsWHERE LOGINPROPERTY(name, N'isLocked') = 1ORDER BY name;
*/
--- CRM Database GrowthSET NOCOUNT ONDECLARE @endDate datetime, @months smallint; SET @endDate = GetDate();  SET @months = 12;          
;WITH HIST AS    (SELECT BS.database_name AS DatabaseName           ,YEAR(BS.backup_start_date) * 100             + MONTH(BS.backup_start_date) AS YearMonth           ,CONVERT(numeric(10, 1), MIN(BS.backup_size / 1048576.0)) AS MinSizeMB           ,CONVERT(numeric(10, 1), MAX(BS.backup_size / 1048576.0)) AS MaxSizeMB           ,CONVERT(numeric(10, 1), AVG(BS.backup_size / 1048576.0)) AS AvgSizeMB     FROM msdb.dbo.backupset as BS     /*WHERE NOT BS.database_name IN               ('master', 'msdb', 'model', 'tempdb','CRM_History','CRM_Integration_PRD',     'CrmDataMigration','MSCRM_CONFIG','ReportServer','ReportServerTempDB','NM_DBA_Maint',     'CRM_Integration_STG_02','CRM1S01_MSCRM','CRM2P_MSCRM','CRM3DLEO_MSCRM','CRM3S01_MSCRM') */ WHERE BS.database_name = 'CRM1P_MSCRM' -- Database name          AND BS.type = 'D'           AND BS.backup_start_date BETWEEN DATEADD(mm, - @months, @endDate) AND     @endDate     GROUP BY BS.database_name             ,YEAR(BS.backup_start_date)             ,MONTH(BS.backup_start_date)) SELECT @@SERVERNAME as ServerName      ,MAIN.DatabaseName       ,MAIN.YearMonth       ,MAIN.MinSizeMB       ,MAIN.MaxSizeMB       ,MAIN.AvgSizeMB       ,MAIN.AvgSizeMB         - (SELECT TOP 1 SUB.AvgSizeMB           FROM HIST AS SUB           WHERE SUB.DatabaseName = MAIN.DatabaseName                 AND SUB.YearMonth < MAIN.YearMonth           ORDER BY SUB.YearMonth DESC) AS GrowthMB FROM HIST AS MAIN ORDER BY MAIN.DatabaseName         ,MAIN.YearMonth
--Query2:
SELECT[database_name] AS "Database",DATEPART(month,[backup_start_date]) AS "Month",AVG([backup_size]/1024/1024) AS "Backup Size MB",AVG([compressed_backup_size]/1024/1024) AS "Compressed Backup Size MB",AVG([backup_size]/[compressed_backup_size]) AS "Compression Ratio"FROM msdb.dbo.backupsetWHERE [database_name] = N'DataBaseName'AND [type] = 'D'GROUP BY [database_name],DATEPART(mm,[backup_start_date]);
-- SQL Keyboard Shortcut:
--CTRL-F1:   --Shows latest backup datesSELECT DATABASE_NAME,CONVERT(VARCHAR(20),MAX(BACKUP_FINISH_DATE)) AS LAST_BACKUP,DATEDIFF(D,MAX(BACKUP_FINISH_DATE),GETDATE()) AS DAYS_SINCE_LAST_BACKUP FROM MSDB.DBO.BACKUPSET WHERE TYPE='D' GROUP BY DATABASE_NAME ORDER BY DAYS_SINCE_LAST_BACKUP DESC;DECLARE @dbname sysname; SET @dbname=NULL;SELECT bup.user_name AS [User],bup.database_name AS [Database],bup.server_name AS [Server],bup.backup_start_date AS [Backup Started],bup.backup_finish_date AS [Backup Finished],CAST((CAST(DATEDIFF(s,bup.backup_start_date,bup.backup_finish_date) AS int))/3600 AS varchar) + ' hours, '+CAST((CAST(DATEDIFF(s,bup.backup_start_date,bup.backup_finish_date) AS int))/60 AS varchar)+ ' minutes, '+CAST((CAST(DATEDIFF(s,bup.backup_start_date,bup.backup_finish_date) AS int))%60 AS varchar)+ ' seconds' AS [Total Time] FROM msdb.dbo.backupset bup WHERE bup.backup_set_id IN (SELECT MAX(backup_set_id) FROM msdb.dbo.backupset WHERE database_name = ISNULL(@dbname,database_name) AND type = 'D' GROUP BY database_name) AND bup.database_name IN (SELECT name FROM master.dbo.sysdatabases) ORDER BY bup.database_name;
--CTRL-3:    -- Shows CPU & RAM, Memory Pressure from OS   -- shows Drive/Disk free space   -- show database, size, owner, Compat Mode, Status, Recovery Model, Resure State   -- shows free space in each DBDECLARE @hr INT,@fso INT,@dr CHAR(1),@odr INT,@TS VARCHAR(20),@MB NUMERIC,@FS INT,@f INT,@RId INT,@LS SMALLINT,@TotS VARCHAR(10),@Pct VARCHAR(3),@cpus varchar(3),@Memory varchar(10),@maxmem sql_variant,@target int,@total int;set @target = (select cntr_value from sys.dm_os_performance_counters where object_name = 'SQLServer:Memory Manager' and counter_name = 'Target Server Memory (KB)');set @total = (select cntr_value from sys.dm_os_performance_counters where object_name = 'SQLServer:Memory Manager' and counter_name = 'Total Server Memory (KB)');create table #Version_info([Index] varchar(5),[Name] varchar(20),Internal_Value varchar(10),Character_Value varchar(120));insert into #Version_info exec ('master..xp_msver');set @cpus = (select Internal_Value from #Version_info where Name='ProcessorCount');set @Memory = (select Internal_Value from #Version_info where Name='PhysicalMemory');set @maxmem = (select value from sys.configurations where [name] like '%max server memory (MB)%');if (@target - @total) > 0 select 'CPUs'=@cpus,'RAM'=@memory,'MaxMem'=@maxmem,'Mem pressure from OS'=str(@target - @total),'Target'=@target,'Total'=@total, (select substring(convert(char(10),crdate,101),1,10) from sys.sysdatabases where [name]='tempdb') LastBoot; else select 'CPUs'=@cpus,'RAM'=@memory,'MaxMem'=@maxmem,'No Mem pressure from OS','Target'=@target,'Total'=@total, (select substring(convert(char(10),crdate,101),1,10) from sys.sysdatabases where [name]='tempdb') LastBoot;drop table #Version_info;CREATE TABLE #drives(id INT IDENTITY(1,1) PRIMARY KEY,drive CHAR(1),FreeSpaceMB INT ,TotalSizeMB INT NULL, PctFree INT);INSERT #drives(drive,FreeSpaceMB) EXEC master.dbo.xp_fixeddrives;EXEC @hr=sp_OACreate 'Scripting.FileSystemObject',@fso OUT;SET @MB=1048576;SET @RId=1;SET @LS=1;WHILE (@LS <> 0) BEGIN;SELECT @dr=drive,@FS=FreeSpaceMB FROM  #drives WHERE ( ID = @RId );IF ( @@ROWCOUNT = 0 )BEGIN SET @LS = 0 END;ELSE BEGIN;EXEC @hr = sp_OAMethod @fso,'GetDrive', @odr OUT, @dr;EXEC @hr =sp_OAGetProperty @odr,'TotalSize', @TS OUT;UPDATE #drives SET TotalSizeMB=@TS/@MB  WHERE  drive=@dr;UPDATE #drives SET PctFree=(@FS/(TotalSizeMB*1.0))*100.0  WHERE drive=@dr;END;SET @RId=@RId+1;END;SELECT * FROM #drives;DROP TABLE #drives;create table #t1(nm sysname,ds varchar(13),ow sysname,di smallint,cr nvarchar(11),st nvarchar(600),co tinyint);insert into #t1 exec sp_helpdb;select 'DB'=nm,'Size(MB)'=cast(substring(ds, 1, len(ds)-2) as decimal), 'Owner'=ow,'Compat'=compatibility_level,state_desc,recovery_model_desc,log_reuse_wait_desc from #t1 t, sys.databases d where t.nm = d.name;drop table #t1;exec sp_MSForeachdb 'Use [?] SELECT substring(physical_name,1,3)+name ,size/128.0 - CAST(FILEPROPERTY(name, ''SpaceUsed'') AS int)/128.0 AS AvailableSpaceInMB FROM sys.database_files;';
--CTRL-4 - for Masterlist   -- Shows what's in SQL_Serversselect * from masterlist..SQL_Servers order by substring(SS_Instance_Name,7,4)
--CTRL-5 - for Masterlist   -- Shows what's in SQL_Server_Infoselect * from masterlist..SQL_Server_Info order by substring(SS_Instance_Name,7,4)
--CTRL-6 - for Masterlist   -- Shows what's in Appsselect * from masterlist..apps order by substring(SS_Instance_Name,7,4)
--CTRL-7 - for Masterlist   -- Shows Max, Total and Avg DB sizes   -- shows SS_Instance_Name, DB_Name, CmptLevel, CreateDate, RecoveryMode, Size, Collationdeclare @maxsize int,@total int,@avgsize varchar(max),@OutputStr varchar(max),@OutputStr1 varchar(max),@OutputStr2 varchar(max),@CharIdx int,@OffSet int;set @maxsize=(select max(size) from masterlist..dbs);set @total=(select sum(size) from masterlist..dbs);set @avgsize=(select avg(size) from masterlist..dbs);SET @OutputStr=REVERSE(@maxsize);SET @CharIdx=CHARINDEX('.', @OutputStr);SET @Offset=@CharIdx;SET @CharIdx=CASE WHEN @CharIdx=0 THEN 1 ELSE @CharIdx END;WHILE @CharIdx <= LEN(@OutputStr) BEGIN IF @CharIdx-@Offset>3 AND (@CharIdx-@Offset-1)%3=0 BEGIN SET @OutputStr=STUFF(@OutputStr,@CharIdx,0,',');SET @Offset=@Offset+1;SET @CharIdx=@CharIdx+1;END;SET @CharIdx=@CharIdx+1;END;SET @OutputStr1=REVERSE(@total);SET @CharIdx=CHARINDEX('.', @OutputStr1);SET @Offset=@CharIdx;SET @CharIdx=CASE WHEN @CharIdx=0 THEN 1 ELSE @CharIdx END;WHILE @CharIdx <= LEN(@OutputStr1) BEGIN IF @CharIdx-@Offset>3 AND (@CharIdx-@Offset-1)%3=0 BEGIN SET @OutputStr1=STUFF(@OutputStr1,@CharIdx,0,',');SET @Offset=@Offset+1;SET @CharIdx=@CharIdx+1;END;SET @CharIdx=@CharIdx+1;END;SET @OutputStr2=REVERSE(@avgsize);SET @CharIdx=CHARINDEX('.', @OutputStr2);SET @Offset=@CharIdx; SET @CharIdx=CASE WHEN @CharIdx=0 THEN 1 ELSE @CharIdx END;WHILE @CharIdx <= LEN(@OutputStr2) BEGIN IF @CharIdx-@Offset>3 AND (@CharIdx-@Offset-1)%3=0 BEGIN SET @OutputStr2=STUFF(@OutputStr2,@CharIdx,0,',');SET @Offset=@Offset+1;SET @CharIdx=@CharIdx+1;END;SET @CharIdx=@CharIdx+1;END;select REVERSE(@OutputStr) as 'Max Size DB',REVERSE(@OutputStr1) as 'Tot Size DB',REVERSE(@OutputStr2) as 'Avg Size DB';select * from masterlist..DBs order by substring(SS_Instance_Name,7,4);
--CTRL-8   -- shows current blocking   -- shows current waity states--Select t1.spid,t1.status,loginame=rtrim(t1.loginame),hostname=LEFT(rtrim(t1.hostname),20),program_name=rtrim(t1.program_name),t1.blocked,t1.dbid,dbname=rtrim((case when t1.dbid=0 then null when t1.dbid<>0 then db_name(t1.dbid) end)),rtrim(t1.nt_username)nt_username,rtrim(t1.cmd)cmd,datediff(minute,t1.last_batch,GETDATE()) waittime_dk,substring(sql.text,stmt_start/2,CASE WHEN stmt_end<1 THEN 8000 ELSE (stmt_end-stmt_start)/2 END) AS RunningSqlText,sql.text as FullSqlText,t1.cpu,substring(convert(varchar,t1.last_batch,111),6,5)+' '+substring(convert(varchar,t1.last_batch,113),13,8)as 'last_batch_time',t1.waittime waittime,t1.lastwaittype From master.dbo.sysprocesses (NOLOCK) t1 cross apply sys.dm_exec_sql_text(t1.sql_handle) AS sql Where t1.blocked<>0 OR t1.spid in (Select t2.blocked From master.dbo.sysprocesses (NOLOCK) t2) Order By t1.dbid DESC,t1.spid;SELECT client_net_address as HOSTIP,Blocking.session_id as BlockingSessionId,Sess.login_name AS BlockingUser,BlockingSQL.text AS BlockingSQL,Waits.wait_type WhyBlocked,Blocked.session_id AS BlockedSessionId,USER_NAME(Blocked.user_id) AS BlockedUser,BlockedSQL.text AS BlockedSQL,DB_NAME(Blocked.database_id) AS DatabaseName FROM sys.dm_exec_connections AS Blocking INNER JOIN sys.dm_exec_requests AS Blocked ON Blocking.session_id=Blocked.blocking_session_id INNER JOIN sys.dm_os_waiting_tasks AS Waits ON Blocked.session_id=Waits.session_id RIGHT OUTER JOIN sys.dm_exec_sessions Sess ON Blocking.session_id=sess.session_id CROSS APPLY sys.dm_exec_sql_text(Blocking.most_recent_sql_handle) AS BlockingSQL CROSS APPLY sys.dm_exec_sql_text(Blocked.sql_handle) AS BlockedSQL ORDER BY BlockingSessionId,BlockedSessionIdSelect t1.spid,t1.status,loginame=rtrim(t1.loginame),hostname=LEFT(rtrim(t1.hostname),20),program_name=rtrim(t1.program_name),t1.blocked,t1.dbid,dbname=rtrim((case when t1.dbid=0 then null when t1.dbid<>0 then db_name(t1.dbid) end)),rtrim(t1.nt_username)nt_username,rtrim(t1.cmd)cmd,datediff(minute,t1.last_batch,GETDATE()) waittime_dk,substring(sql.text,stmt_start/2,CASE WHEN stmt_end<1 THEN 8000 ELSE (stmt_end-stmt_start)/2 END) AS RunningSqlText,sql.text as FullSqlText,t1.cpu,substring(convert(varchar,t1.last_batch,111),6,5)+' '+substring(convert(varchar,t1.last_batch,113),13,8)as 'last_batch_time',t1.waittime waittime,t1.lastwaittype From master.dbo.sysprocesses (NOLOCK) t1 cross apply sys.dm_exec_sql_text(t1.sql_handle) AS sql Where t1.blocked<>0 OR t1.spid in (Select t2.blocked From master.dbo.sysprocesses (NOLOCK) t2) Order By t1.dbid DESC,t1.spid;SELECT client_net_address as HOSTIP,Blocking.session_id as BlockingSessionId,Sess.login_name AS BlockingUser,BlockingSQL.text AS BlockingSQL,Waits.wait_type WhyBlocked,Blocked.session_id AS BlockedSessionId,USER_NAME(Blocked.user_id) AS BlockedUser,BlockedSQL.text AS BlockedSQL,DB_NAME(Blocked.database_id) AS DatabaseName FROM sys.dm_exec_connections AS Blocking INNER JOIN sys.dm_exec_requests AS Blocked ON Blocking.session_id=Blocked.blocking_session_id INNER JOIN sys.dm_os_waiting_tasks AS Waits ON Blocked.session_id=Waits.session_id RIGHT OUTER JOIN sys.dm_exec_sessions Sess ON Blocking.session_id=sess.session_id CROSS APPLY sys.dm_exec_sql_text(Blocking.most_recent_sql_handle) AS BlockingSQL CROSS APPLY sys.dm_exec_sql_text(Blocked.sql_handle) AS BlockedSQL ORDER BY BlockingSessionId,BlockedSessionId;declare @wc varchar(50),@num_waits bigint,@tot_wait_time bigint;create table #t1(wtype varchar(50),wc varchar(50),nm bigint,wt bigint,mwt bigint);create table #t2(wc varchar(50),nm int,wt bigint);insert into #t1 EXEC msdb.MS_PerfDashboard.usp_DmOsWaitStats;set @tot_wait_time=(select sum(wt) from #t1);set @tot_wait_time=(select convert(decimal(14,2), @tot_wait_time));declare cnt_wc cursor for select distinct(wc) from #t1;open cnt_wc;fetch next from cnt_wc into @wc;WHILE @@FETCH_STATUS = 0 BEGIN insert into #t2 select wc, count(wc), sum(wt) from #t1 where wc = @wc group by wc; FETCH NEXT FROM cnt_wc INTO @wc;END;CLOSE cnt_wc;DEALLOCATE cnt_wc;select 'Wait Category'=wc,'No Waits'=nm,'Wait Time (sec)'=wt,'Pct Time'=str((((convert(decimal(14,2),wt))/@tot_wait_time)*100)) from #t2 order by 3 desc;drop table #t1;drop table #t2;
--CTRL-9   -- TempDB object   -- memory usage   -- shows top 20 longest queries      -- mkissing indexesSELECT top 5 so.[name],used AS "# of Pages",rows AS "# of Rows",(used*8)/1024 AS "# of MB" FROM tempdb..sysobjects so JOIN tempdb..sysindexes si ON so.id=si.id WHERE so.xtype = 'U' ORDER BY used DESC;SELECT SUM (user_object_reserved_page_count) *8 AS usr_obj_kb,SUM (internal_object_reserved_page_count)*8 AS inefficient_queries,SUM (version_store_reserved_page_count) *8 AS version_store_kb,SUM (unallocated_extent_page_count) *8 AS freespace_kb,SUM (mixed_extent_page_count) * 8 AS mixedextent_kb FROM tempdb.sys.dm_db_file_space_usage WHERE database_id = 2;SELECT TOP 20[Total IO]=(qs.total_logical_reads+qs.total_logical_writes),[Average IO]=(qs.total_logical_reads+qs.total_logical_writes)/qs.execution_count,qs.execution_count,SUBSTRING (qt.text,(qs.statement_start_offset/2)+1,((CASE WHEN qs.statement_end_offset=-1 THEN LEN(CONVERT(NVARCHAR(MAX),qt.text))*2 ELSE qs.statement_end_offset END-qs.statement_start_offset)/2)+1) AS [Individual Query],qt.text AS [Parent Query],DB_NAME(qt.dbid)AS DatabaseName,qp.query_plan FROM sys.dm_exec_query_stats qs CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) as qt CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) qp ORDER BY [Total IO] DESC;SELECT @@Servername as servername,migs.avg_total_user_cost*(migs.avg_user_impact/100.0)*(migs.user_seeks+migs.user_scans) AS improvement_measure,'CREATE INDEX [mi_'+CONVERT(varchar,mig.index_group_handle)+'_'+CONVERT(varchar,mid.index_handle)+'_'+LEFT(PARSENAME(mid.statement,1),32)+']'+' ON '+mid.statement +' ('+ISNULL(mid.equality_columns,'')+CASE WHEN mid.equality_columns IS NOT NULL AND mid.inequality_columns IS NOT NULL THEN ',' ELSE '' END +ISNULL (mid.inequality_columns,'')+')'+ISNULL(' INCLUDE ('+mid.included_columns+')','') AS create_index_statement,db_name(mid.database_id) FROM sys.dm_db_missing_index_groups mig INNER JOIN sys.dm_db_missing_index_group_stats migs ON migs.group_handle=mig.index_group_handle INNER JOIN sys.dm_db_missing_index_details mid ON mig.index_handle=mid.index_handle WHERE migs.avg_total_user_cost*(migs.avg_user_impact/100.0)*(migs.user_seeks+migs.user_scans)>10 ORDER BY migs.avg_total_user_cost*migs.avg_user_impact*(migs.user_seeks+migs.user_scans) DESC;--SELECT top 5 so.[name],used AS "# of Pages",rows AS "# of Rows",(used*8)/1024 AS "# of MB" FROM tempdb..sysobjects so JOIN tempdb..sysindexes si ON so.id=si.id WHERE so.xtype = 'U' ORDER BY used DESC;SELECT SUM (user_object_reserved_page_count) *8 AS usr_obj_kb,SUM (internal_object_reserved_page_count)*8 AS internal_obj_kb,SUM (version_store_reserved_page_count) *8 AS version_store_kb,SUM (unallocated_extent_page_count) *8 AS freespace_kb,SUM (mixed_extent_page_count) * 8 AS mixedextent_kb FROM tempdb.sys.dm_db_file_space_usage WHERE database_id = 2;SELECT TOP 20[Total IO]=(qs.total_logical_reads+qs.total_logical_writes),[Average IO]=(qs.total_logical_reads+qs.total_logical_writes)/qs.execution_count,qs.execution_count,SUBSTRING (qt.text,(qs.statement_start_offset/2)+1,((CASE WHEN qs.statement_end_offset=-1 THEN LEN(CONVERT(NVARCHAR(MAX),qt.text))*2 ELSE qs.statement_end_offset END-qs.statement_start_offset)/2)+1) AS [Individual Query],qt.text AS [Parent Query],DB_NAME(qt.dbid)AS DatabaseName,qp.query_plan FROM sys.dm_exec_query_stats qs CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) as qt CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) qp ORDER BY [Total IO] DESC;
--CTRL-0   -- shows db/file sizes and virtual IO stats--select m.name as file_name,m.physical_name,(fs.size_on_disk_bytes/1024)/1024 as 'Size (MB)',fs.num_of_reads,fs.num_of_bytes_read,fs.io_stall_read_ms,fs.num_of_writes,fs.num_of_bytes_written,fs.io_stall_write_ms,m.state_desc,d.log_reuse_wait_desc,d.recovery_model_desc,d.create_date from sys.dm_io_virtual_file_stats(NULL, NULL) fs join sys.master_files m on fs.database_id = m.database_id and fs.file_id = m.file_id, sys.databases d where d.database_id=m.database_id order by 2,1;select m.name as file_name,m.physical_name,(fs.size_on_disk_bytes/1024)/1024 as 'Size (MB)',m.state_desc,d.log_reuse_wait_desc,d.recovery_model_desc,d.create_date from sys.dm_io_virtual_file_stats(NULL, NULL) fs join sys.master_files m on fs.database_id = m.database_id and fs.file_id = m.file_id, sys.databases d where d.database_id=m.database_id order by 2,1;DECLARE @TotalIO BIGINT,@TotalBytes BIGINT,@TotalStall BIGINT;SELECT @TotalIO = SUM(NumberReads + NumberWrites),@TotalBytes = SUM(BytesRead + BytesWritten),@TotalStall = SUM(IoStallMS) FROM :: FN_VIRTUALFILESTATS(NULL,NULL);SELECT substring((SELECT physical_name FROM sys.master_files WHERE database_id = [DbId] AND FILE_ID=[FileId]),1,2) Drive,(SELECT name FROM sys.master_files WHERE database_id = [DbId] AND FILE_ID = [FileId]) filename,[%ReadWrites]=(100*(NumberReads+NumberWrites)/@TotalIO),[%Bytes]=(100*(BytesRead+BytesWritten)/@TotalBytes),[%Stall]=(100*IoStallMS/@TotalStall),[NumberReads],[NumberWrites],[TotalIO]=CAST((NumberReads+NumberWrites)AS BIGINT),[MBsRead]=[BytesRead]/(1024*1024 ),[MBsWritten]=[BytesWritten]/(1024*1024),[TotalMBs]=(BytesRead+BytesWritten)/(1024*1024),[IoStallMS],IoStallReadMS,IoStallWriteMS,[AvgStallPerIO]=([IoStallMS]/([NumberReads]+[NumberWrites]+1)),[AvgStallPerReadIO]=(IoStallReadMS/([NumberReads]+1)),[AvgStallPerWriteIO]=(IoStallWriteMS/([NumberWrites]+1)),[AvgBytesPerRead]=((BytesRead)/(NumberReads+1)),[AvgBytesPerWrite]=((BytesWritten)/(NumberWrites+1)) FROM::FN_VIRTUALFILESTATS(NULL,NULL) order by 5 desc;
-- Blocking ProcessSELECTdb.name DBName,tl.request_session_id,wt.blocking_session_id,OBJECT_NAME(p.OBJECT_ID) BlockedObjectName,tl.resource_type,h1.TEXT AS RequestingText,h2.TEXT AS BlockingTest,tl.request_modeFROM sys.dm_tran_locks AS tlINNER JOIN sys.databases db ON db.database_id = tl.resource_database_idINNER JOIN sys.dm_os_waiting_tasks AS wt ON tl.lock_owner_address = wt.resource_addressINNER JOIN sys.partitions AS p ON p.hobt_id = tl.resource_associated_entity_idINNER JOIN sys.dm_exec_connections ec1 ON ec1.session_id = tl.request_session_idINNER JOIN sys.dm_exec_connections ec2 ON ec2.session_id = wt.blocking_session_idCROSS APPLY sys.dm_exec_sql_text(ec1.most_recent_sql_handle) AS h1CROSS APPLY sys.dm_exec_sql_text(ec2.most_recent_sql_handle) AS h2 GO
-- Identifying the SQL Server Service AccountSELECT  DSS.servicename,        DSS.startup_type_desc,        DSS.status_desc,        DSS.last_startup_time,        DSS.service_account,        DSS.is_clustered,        DSS.cluster_nodename,        DSS.filename,        DSS.startup_type,        DSS.status,        DSS.process_idFROM    sys.dm_server_services AS DSS;
/* Collation used by all the databases on a SQL Server instance */USE MasterGOSELECT NAME,  COLLATION_NAMEFROM sys.Databases ORDER BY DATABASE_ID ASCGO
SELECT name, physical_name AS current_file_locationFROM sys.master_files
--Server Drive space detailSELECT DISTINCT  vs.volume_mount_point AS [Drive],  vs.logical_volume_name AS [Drive Name],  vs.total_bytes/1024/1024 AS [Drive Size in MB],  vs.available_bytes/1024/1024 AS [Drive Free Space in MB]FROM sys.master_files AS fCROSS APPLY sys.dm_os_volume_stats(f.database_id, f.file_id) AS vsORDER BY vs.volume_mount_point;
-----------------declare @svrName varchar(255)declare @sql varchar(400)--by default it will take the current server name, we can the set the server name as wellset @svrName = @@SERVERNAMEset @sql = 'powershell.exe -c "Get-WmiObject -ComputerName ' + QUOTENAME(@svrName,'''') + ' -Class Win32_Volume -Filter ''DriveType = 3'' | select name,capacity,freespace | foreach{$_.name+''|''+$_.capacity/1048576+''%''+$_.freespace/1048576+''*''}"'--creating a temporary tableCREATE TABLE #output(line varchar(255))--inserting disk name, total space and free space value in to temporary tableinsert #outputEXEC xp_cmdshell @sql--script to retrieve the values in MB from PS Script outputselect rtrim(ltrim(SUBSTRING(line,1,CHARINDEX('|',line) -1))) as Drive   ,round(cast(rtrim(ltrim(SUBSTRING(line,CHARINDEX('|',line)+1,   (CHARINDEX('%',line) -1)-CHARINDEX('|',line)) )) as Float),0) as 'Capacity(MB)'   ,round(cast(rtrim(ltrim(SUBSTRING(line,CHARINDEX('%',line)+1,   (CHARINDEX('*',line) -1)-CHARINDEX('%',line)) )) as Float),0) as 'Freespace(MB)'from #outputwhere line like '[A-Z][:]%'order by Drive--script to retrieve the values in GB from PS Script outputselect rtrim(ltrim(SUBSTRING(line,1,CHARINDEX('|',line) -1))) as Drive   ,round(cast(rtrim(ltrim(SUBSTRING(line,CHARINDEX('|',line)+1,   (CHARINDEX('%',line) -1)-CHARINDEX('|',line)) )) as Float)/1024,0) as 'capacity(GB)'   ,round(cast(rtrim(ltrim(SUBSTRING(line,CHARINDEX('%',line)+1,   (CHARINDEX('*',line) -1)-CHARINDEX('%',line)) )) as Float) /1024 ,0)as 'freespace(GB)'from #outputwhere line like '[A-Z][:]%'order by Drive--script to drop the temporary tabledrop table #output
-------------------Database files detailSELECT f.name AS [File Name] , f.physical_name AS [Physical Name], CAST((f.size/128.0) AS DECIMAL(15,2)) AS [Total Size in MB],CAST(f.size/128.0 - CAST(FILEPROPERTY(f.name, 'SpaceUsed') AS int)/128.0 AS DECIMAL(15,2)) AS [Available Space In MB], [file_id], fg.name AS [Filegroup Name]FROM sys.database_files AS f WITH (NOLOCK) LEFT OUTER JOIN sys.data_spaces AS fg WITH (NOLOCK) ON f.data_space_id = fg.data_space_id OPTION (RECOMPILE);
SELECT --    [file_id] AS [File ID],--    [type] AS [File Type],--    substring([physical_name],1,1) AS [Drive],    [name] AS [Logical Name],    [physical_name] AS [Physical Name],    CAST([size] as DECIMAL(38,0))/128. AS [File Size in MB],     CAST(FILEPROPERTY([name],'SpaceUsed') AS DECIMAL(38,0))/128. AS [Space Used in MB],     (CAST([size] AS DECIMAL(38,0))/128) - (CAST(FILEPROPERTY([name],'SpaceUsed') AS DECIMAL(38,0))/128.) AS [Free Space in MB]--,   -- [max_size] AS [Max Size],   -- [is_percent_growth] AS [Percent Growth Enabled],   -- [growth] AS [Growth Rate]--,    --SYSDATETIME() AS [Current Date]FROM sys.database_files;

*************************************************************** END **********

Blocking...

USE PST7GO
--SELECT  --    OBJECT_NAME(p.[object_id]) BlockedObject--FROM    sys.dm_exec_connections AS blocking--    INNER JOIN sys.dm_exec_requests blocked--        ON blocking.session_id = blocked.blocking_session_id--    INNER JOIN sys.dm_os_waiting_tasks waitstats--        ON waitstats.session_id = blocked.session_id--    INNER JOIN sys.partitions p ON SUBSTRING(resource_description, --        PATINDEX('%associatedObjectId%', resource_description) + 19, --        LEN(resource_description)) = p.partition_id
SELECT db_name(rsc_dbid) AS 'DATABASE_NAME',--case rsc_type when 1 then 'null'--              when 2 then 'DATABASE' --              WHEN 3 THEN 'FILE'--              WHEN 4 THEN 'INDEX'--              WHEN 5 THEN 'TABLE'--              WHEN 6 THEN 'PAGE'--              WHEN 7 THEN 'KEY'--              WHEN 8 THEN 'EXTEND'--              WHEN 9 THEN 'RID ( ROW ID)'--              WHEN 10 THEN 'APPLICATION' end  AS 'REQUEST_TYPE',
CASE req_ownertype WHEN 1 THEN 'TRANSACTION'                   WHEN 2 THEN 'CURSOR'                   WHEN 3 THEN 'SESSION'                   WHEN 4 THEN 'ExSESSION' END AS 'REQUEST_OWNERTYPE',
OBJECT_NAME(rsc_objid ,rsc_dbid) AS 'OBJECT_NAME', PROCESS.HOSTNAME , PROCESS.program_name , PROCESS.nt_domain , PROCESS.nt_username , PROCESS.program_name ,SQLTEXT.text FROM sys.syslockinfo LOCK JOIN      sys.sysprocesses PROCESS  ON LOCK.req_spid = PROCESS.spidCROSS APPLY sys.dm_exec_sql_text(PROCESS.SQL_HANDLE) SQLTEXT
--sp_who2
